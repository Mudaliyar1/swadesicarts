<!-- Media Carousel Component -->
<div class="media-carousel-container">
    <!-- Main Media Display -->
    <% 
        const allMedia = [];
        if (featuredImage && featuredImage.url) {
            allMedia.push({
                url: featuredImage.url,
                type: 'image',
                isFeatured: true
            });
        }
        if (gallery && Array.isArray(gallery) && gallery.length > 0) {
            gallery.forEach(item => {
                allMedia.push({
                    url: item.url,
                    type: item.type || 'image',
                    isFeatured: false
                });
            });
        }
    %>

    <% if (allMedia.length > 0) { %>
        <div style="position: relative; width: 100%;" id="carouselMainContainer">
            <% if (allMedia[0].type === 'video') { %>
                <video id="mainMedia" src="<%= allMedia[0].url %>" class="carousel-main-media video" controls style="width: 100%; height: auto; max-height: 600px; object-fit: cover; display: block;"></video>
                <span class="carousel-video-badge"><i class="bi bi-play-circle"></i> VIDEO</span>
            <% } else { %>
                <img id="mainMedia" src="<%= allMedia[0].url %>" alt="Product" class="carousel-main-media" style="width: 100%; height: auto; max-height: 600px; object-fit: cover; display: block; border-radius: 8px;">
            <% } %>
        </div>

        <!-- Thumbnails - Always show if multiple items -->
        <% if (allMedia.length > 1) { %>
            <div class="carousel-thumbnails" style="margin-top: 1rem;">
                <% allMedia.forEach((media, index) => { %>
                    <div class="carousel-thumbnail-item <%= index === 0 ? 'active' : '' %>" 
                         data-index="<%= index %>"
                         style="cursor: pointer;">
                        
                        <% if (media.type === 'video') { %>
                            <video src="<%= media.url %>" style="width: 100%; height: 100%; object-fit: cover;"></video>
                            <span class="carousel-thumbnail-badge"><i class="bi bi-play-circle-fill"></i></span>
                        <% } else { %>
                            <img src="<%= media.url %>" alt="Gallery thumbnail <%= index %>" style="width: 100%; height: 100%; object-fit: cover;">
                        <% } %>
                    </div>
                <% }); %>
            </div>

            <!-- Counter -->
            <div class="carousel-counter" style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                <span id="mediaCounter">1</span> / <span id="mediaTotal"><%= allMedia.length %></span>
            </div>
        <% } %>
    <% } else { %>
        <div class="carousel-main-media" style="display: flex; align-items: center; justify-content: center; color: #999; background-color: #f8f9fa; border-radius: 8px; aspect-ratio: 1;">
            <i class="bi bi-image" style="font-size: 3rem;"></i>
        </div>
    <% } %>
</div>

<script>
    // Carousel initialization
    (function() {
        let currentMediaIndex = 0;
        const allMediaItems = <%- JSON.stringify(allMedia) %>;

        window.carouselChangeMedia = function(index) {
            if (index < 0 || index >= allMediaItems.length) return;
            
            currentMediaIndex = index;
            const media = allMediaItems[index];
            const mainContainer = document.getElementById('carouselMainContainer');
            
            if (!mainContainer) return;

            // Build new main media HTML
            let newHTML = '';
            if (media.type === 'video') {
                newHTML = `
                    <video id="mainMedia" src="${media.url}" class="carousel-main-media video" controls style="width: 100%; height: auto; max-height: 600px; object-fit: cover; display: block;"></video>
                    <span class="carousel-video-badge"><i class="bi bi-play-circle"></i> VIDEO</span>
                `;
            } else {
                newHTML = `<img id="mainMedia" src="${media.url}" alt="Product" class="carousel-main-media" style="width: 100%; height: auto; max-height: 600px; object-fit: cover; display: block; border-radius: 8px;">`;
            }
            
            mainContainer.innerHTML = newHTML;

            // Update thumbnail active state
            document.querySelectorAll('.carousel-thumbnail-item').forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });

            // Update counter
            const counter = document.getElementById('mediaCounter');
            if (counter) counter.textContent = index + 1;
        };

        // Add click handlers to thumbnails
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.carousel-thumbnail-item').forEach((item) => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const index = parseInt(this.getAttribute('data-index'));
                    window.carouselChangeMedia(index);
                });
            });
        });

        // Also bind immediately in case DOM is already loaded
        document.querySelectorAll('.carousel-thumbnail-item').forEach((item) => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const index = parseInt(this.getAttribute('data-index'));
                window.carouselChangeMedia(index);
            });
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(event) {
            const mainMedia = document.getElementById('mainMedia');
            if (!mainMedia) return;
            
            if (event.key === 'ArrowLeft' && currentMediaIndex > 0) {
                window.carouselChangeMedia(currentMediaIndex - 1);
            } else if (event.key === 'ArrowRight' && currentMediaIndex < allMediaItems.length - 1) {
                window.carouselChangeMedia(currentMediaIndex + 1);
            }
        });
    })();
</script>
