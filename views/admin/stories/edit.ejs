<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Story - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body class="admin-body">
    <nav class="navbar navbar-dark bg-swadesi d-lg-none">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <span class="navbar-brand mb-0">Stories</span>
            <a href="/admin/logout" class="btn btn-sm btn-outline-light"><i class="bi bi-box-arrow-right"></i></a>
        </div>
    </nav>

    <div class="admin-sidebar d-none d-lg-flex flex-column" id="sidebarDesktop">
        <div class="sidebar-header">
            <h5 class="mb-0"><i class="bi bi-speedometer2"></i> <span class="sidebar-text">Admin Panel</span></h5>
        </div>
        <ul class="sidebar-nav flex-grow-1">
            <li><a href="/admin/dashboard" title="Dashboard"><i class="bi bi-speedometer2"></i><span class="sidebar-text">Dashboard</span></a></li>
            <li><a href="/admin/seasonal-products" title="Seasonal Products"><i class="bi bi-calendar3"></i><span class="sidebar-text">Seasonal Products</span></a></li>
            <li><a href="/admin/tech-packages" title="Tech Packages"><i class="bi bi-laptop"></i><span class="sidebar-text">Tech Packages</span></a></li>
            <li><a href="/admin/organic-products" title="Organic Products"><i class="bi bi-flower2"></i><span class="sidebar-text">Organic Products</span></a></li>
            <li><a href="/admin/stories" class="active" title="Stories"><i class="bi bi-images"></i><span class="sidebar-text">Stories</span></a></li>
            <li><a href="/admin/inquiries" title="Inquiries"><i class="bi bi-chat-dots"></i><span class="sidebar-text">Inquiries</span></a></li>
            <li><a href="/admin/visitors" title="Visitors"><i class="bi bi-person-lines-fill"></i><span class="sidebar-text">Visitors</span></a></li>
            <li><a href="/admin/admins" title="Admin Users"><i class="bi bi-people"></i><span class="sidebar-text">Admin Users</span></a></li>
            <li><a href="/admin/settings" title="Website Settings"><i class="bi bi-gear"></i><span class="sidebar-text">Website Settings</span></a></li>
        </ul>
        <div class="sidebar-footer">
            <a href="/" target="_blank" title="View Website"><i class="bi bi-globe"></i><span class="sidebar-text">View Website</span></a>
            <a href="/admin/logout" title="Logout"><i class="bi bi-box-arrow-right"></i><span class="sidebar-text">Logout</span></a>
        </div>
        <button class="sidebar-toggle d-none d-lg-block" id="sidebarToggle"><i class="bi bi-chevron-left"></i></button>
    </div>

    <div class="offcanvas offcanvas-start bg-swadesi text-white" tabindex="-1" id="sidebar">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Admin Panel</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0">
            <ul class="sidebar-nav-mobile">
                <li><a href="/admin/dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                <li><a href="/admin/seasonal-products"><i class="bi bi-calendar3"></i> Seasonal Products</a></li>
                <li><a href="/admin/tech-packages"><i class="bi bi-laptop"></i> Tech Packages</a></li>
                <li><a href="/admin/organic-products"><i class="bi bi-flower2"></i> Organic Products</a></li>
                <li><a href="/admin/stories"><i class="bi bi-images"></i> Stories</a></li>
                <li><a href="/admin/inquiries"><i class="bi bi-chat-dots"></i> Inquiries</a></li>
                <li><a href="/admin/visitors"><i class="bi bi-person-lines-fill"></i> Visitors</a></li>
                <li><a href="/admin/admins"><i class="bi bi-people"></i> Admin Users</a></li>
                <li><a href="/admin/settings"><i class="bi bi-gear"></i> Website Settings</a></li>
                <li><a href="/" target="_blank"><i class="bi bi-globe"></i> View Website</a></li>
                <li><a href="/admin/logout"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
            </ul>
        </div>
    </div>

    <div class="admin-content">
        <div class="container-fluid p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-pencil-circle"></i> Edit Story</h2>
                <a href="/admin/stories" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <form id="storyForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="title" class="form-label">Story Title <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="title" name="title" value="<%= story.title %>" placeholder="Enter story title" required>
                                </div>

                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="Enter story description (optional)"><%= story.description %></textarea>
                                    <small class="text-muted">Max 500 characters</small>
                                </div>

                                <div class="mb-3">
                                    <label for="media" class="form-label">Add More Media (Images or Videos)</label>
                                    <input type="file" class="form-control" id="media" name="media" accept="image/*,video/*" multiple>
                                    <small class="text-muted">Select multiple files (up to 10). New media will be added to existing ones.</small>
                                </div>

                                <div class="mb-3">
                                    <label for="displayOrder" class="form-label">Display Order</label>
                                    <input type="number" class="form-control" id="displayOrder" name="displayOrder" value="<%= story.displayOrder %>" min="0">
                                    <small class="text-muted">Lower number appears first (0 = first)</small>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="isActive" name="isActive" <%= story.isActive ? 'checked' : '' %>>
                                        <label class="form-check-label" for="isActive">
                                            Active (visible on website)
                                        </label>
                                    </div>
                                </div>

                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="/admin/stories" class="btn btn-outline-secondary">Cancel</a>
                                    <button type="submit" class="btn btn-swadesi">
                                        <i class="bi bi-check-circle"></i> Update Story
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card shadow-sm border-0 mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-images"></i> Current Media (<%= story.media.length %>)</h6>
                        </div>
                        <div class="card-body">
                            <% story.media.forEach((media, index) => { %>
                                <div class="mb-3 text-center" style="padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                    <% if (media.type === 'video') { %>
                                        <video src="<%= media.url %>" style="max-width: 100%; max-height: 200px; border-radius: 8px; background: #000;"></video>
                                        <p class="mt-2 mb-0"><span class="badge bg-info"><i class="bi bi-camera-video"></i> Video <%= index + 1 %></span></p>
                                    <% } else { %>
                                        <img src="<%= media.url %>" alt="Media <%= index + 1 %>" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                                        <p class="mt-2 mb-0"><span class="badge bg-warning"><i class="bi bi-image"></i> Image <%= index + 1 %></span></p>
                                    <% } %>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                    
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-cloud-upload"></i> New Media Preview</h6>
                        </div>
                        <div class="card-body">
                            <div id="newMediaPreviewContainer" style="display: none;">
                                <!-- New media previews will be inserted here -->
                            </div>
                            <div id="noNewPreview" class="text-center text-muted">
                                <i class="bi bi-cloud-upload" style="font-size: 2rem; opacity: 0.5;"></i>
                                <p class="mt-2">Upload new media to see preview</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/admin.js"></script>
    <script>
        const mediaInput = document.getElementById('media');
        const newMediaPreviewContainer = document.getElementById('newMediaPreviewContainer');
        const noNewPreview = document.getElementById('noNewPreview');

        mediaInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) {
                newMediaPreviewContainer.style.display = 'none';
                noNewPreview.style.display = 'block';
                return;
            }

            newMediaPreviewContainer.innerHTML = '';
            newMediaPreviewContainer.style.display = 'block';
            noNewPreview.style.display = 'none';

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const isVideo = file.type.startsWith('video');
                    const mediaDiv = document.createElement('div');
                    mediaDiv.className = 'mb-3 text-center';
                    
                    if (isVideo) {
                        mediaDiv.innerHTML = `
                            <video src="${event.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 8px; background: #000;" controls></video>
                            <div class="mt-2"><span class="badge bg-info"><i class="bi bi-camera-video"></i> New Video ${index + 1}</span></div>
                        `;
                    } else {
                        mediaDiv.innerHTML = `
                            <img src="${event.target.result}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                            <div class="mt-2"><span class="badge bg-warning"><i class="bi bi-image"></i> New Image ${index + 1}</span></div>
                        `;
                    }
                    
                    newMediaPreviewContainer.appendChild(mediaDiv);
                };
                reader.readAsDataURL(file);
            });
        });

        document.getElementById('storyForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Updating...';

                const response = await fetch('/admin/stories/edit/<%= story._id %>', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert('Story updated successfully!');
                    window.location.href = '/admin/stories';
                } else {
                    alert('Error: ' + (data.error || 'Failed to update story'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating story');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    </script>
</body>
</html>
